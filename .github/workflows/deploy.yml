name: Laravel Deployment Pipeline

on:
  push:
    branches:
      - main

jobs:
  # Job 1: Setup environment and build
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clone the repository
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: uses: actions/cache@v3
        with:
          php-version: '8.0'  # Adjust to your Laravel version

      - name: Install Composer dependencies
        run: |
          curl -sS https://getcomposer.org/installer | php
          php composer.phar install --no-interaction --prefer-dist --optimize-autoloader

      - name: Cache Composer dependencies
        uses: actions/cache@v2
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

  # Job 2: Run tests
  test:
    runs-on: ubuntu-latest
    needs: build  # This job depends on the build job
    steps:
      - name: Clone the repository
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'

      - name: Install Composer dependencies
        run: |
          curl -sS https://getcomposer.org/installer | php
          php composer.phar install --no-interaction --prefer-dist --optimize-autoloader

      - name: Run tests
        run: |
          php artisan migrate --env=testing
          php artisan test

  # Job 3: Deploy to cPanel (via SSH)
 build:
  runs-on: ubuntu-latest
  steps:
    - name: Clone the repository
      uses: actions/checkout@v3

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'  # Adjust to your Laravel version

    - name: Install Composer dependencies
      run: |
        curl -sS https://getcomposer.org/installer | php
        php composer.phar install --no-interaction --prefer-dist --optimize-autoloader

    - name: Cache Composer dependencies
      uses: actions/cache@v2
      with:
        path: ~/.composer/cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
